# 1. Цель проекта

Цель проекта - создать удобный сервис для авторов тг каналов (далее "Сервис"). Автор сможет управлять тегами к постам; настраивать шаблон поста, шаблон репоста/поста из предложки.

# 2. Описание сервиса

Сервис будет включать следующие функциональные блоки:
1. Регистрация, аутентификация и авторизация.
2. Функционал Автора. <br>
2.1 Функционал управления шаблонами. <br>
2.2 Функционал публикации постов в формате шаблона.
3. Функционал Подписчика. <br>
3.1 Функционал предложенных постов от подписчиков (далее "Предложка").

## 2.1. Типы пользователей

Прежде, чем рассматривать регистрацию, аутентификацию и авторизацию, нужно определиться с типами пользователей.
Всего будет два пользователя:
- Подписчик - обычный пользователь, который может предлагать посты.
- Автор - пользователь, который выкладывает свои посты, создаёт шаблоны постов и публикуют посты из предложки.

## 2.2. Регистрация

Сервис имеет тип распространения PaaS (Platform as a Service), и это значит, что данный продукт будет привязываться к какому-то конкретному телеграмм-каналу, а в частности к автору.
Любой автор сможет развернуть Сервис на своих машинах, т.к. он предоставляется бесплатно и имеет открытый исходный код.

Процесс регистрации автора в Системе, будет происходить из командной строки, а именно команды запуска Сервиса, в аргументы которой должен быть передан id телеграмм аккаунта Автора.

Процесс регистрации Подписчика будет происходить через телеграмм бота, который будет сохранять информацию об аккаунте пользователя в Б/Д, тем самым регистрируя его в Системе.
Желательно предусмотреть проверку по наличию номера телефона пользователя у аккаунта, чтобы снизить любые атаки на Предложку к минимуму.

## 2.3. Аутентификация пользователей

Аутентификация Автора и Подписчиков осуществляется по id телеграмм аккаунта пользователя.
Нужно предусмотреть возможность смены id телеграмм аккаунта у автора через командную строку.

## 2.4. Функционал Автора

Автор имеет следующие возможности:
1. Создавать, редактировать, добавлять и удалять шаблоны для постов.
2. Добавлять теги постов
3. Создавать посты, пересылать посты, статьи и другое, убирать ссылку на оригинал, ставить посты в очередь, публиковать посты внеочереди, редактировать неопубликованные посты, прикреплять к постам существующие теги.
4. Публиковать, редактировать, отколнять посты из Предложки и прикреплять к ним существующие теги.

### 2.4.1 Создание шаблона и иже с ним

Для создания шаблона будут использоваться следующие правила:
1. Переменные, которые будут содержать в себе текст выглядят так:
 - text - текст, который будет написан от Автора канала
 - tags - теги к посту
 - repost_text - текст, который был написан в репосте
 - repost_author - автор поста, который был в репосте
 - repost_url - ссылка на репост
2. Переменные обрамляются в фигурные скобки: {text}
3. Для форматировании текста используется формат markdown.

### 2.4.2. Создание тегов и иже с ними

Теги должны сортироваться по использованию и добавлению.
Добавить возможность добавлять новые теги, сканируя их из старых постов.
Добавить возможность добавлять сразу несколько новых тегов в одном сообщении.

При удалении тега из Сервиса, удалять тег из всех постов в очереди (желательно из всех постов в канале)

### 2.4.3 Создание поста и иже с ним

Для написания поста будет использоваться, либо триггер, что сообщение было переслано, либо кнопкой "Новый пост":
1. В первом случае, если пост из тг, то копируется ссылка на пост, имя канала/источника, текст поста, вложения поста, после чего происходит переход к шагу два. Во втором случае, ничего не копируется и происходит переход к шагу два. Если пост не из тг, то происходит переход по ссылке, парсится h1, текст к посту (если ВК), обложка поста (прикреплённые медиафайлы, если ВК).
2. Далее, добавляется текст, и пост форматируется по шаблону.
3. Добавляются теги.
4. Ставится время публикации.
5. Пост становится в очередь в канале.

Для редактировании поста, он должен быть в очереди на публикацию:
1. Из меню выбирается нужный пост.
2. Выбирается нужный пункт для редактировании.
3. Сохраняется новый пост в очереди, заменяя собой старый.

Для публикации поста внеочереди, нужно выбрать его в меню очереди на публикации и нажать на соответсвующию кнопку.

### 2.4.4 Предложка для автора

Для публикации поста из предложки, используется та же схема, что и в перессылке постов из тг.
Можно убрать пост из предложки, заброковав его - отправится уведомлению пользователю, что пост не подходит, при желании можно указать причину.
Можно убирать авторство подписчика, если тот подтвердит своё согласие на это.

## 2.5 Функционал Подписчика

Подписчик имеет следующие возможности:
1. Предалагать новость, пост и прочее
2. Получать уведомление об изменении статусе предложенного поста.


## 2.5.1 Предложение поста и иже с ним

При регистрации пользователя запрашивать номер телефона, аргументируя это тем, что это защита от спама.
Добавить возможность Автору отключать эту функцию.

Чтобы предложить пост пользователь должен проделать следующие действия:
1. Выбрать в меню "Предложить пост"
2. Написать текст к посту, в т.ч. прикрепить медиафайлы
3. Согласиться или не соглашаться с указанием авторства и ссылки на аккаунт Подписчика <br>
3.1 Если нет ника, предупредить пользователя, что будет использован номер телефона Подписчика.

Возможно, стоит добавить статистику по постам, типо сколько опубликованных, сколько неопубликованных, сколько заброкованных.
Возможно сделать видимость только для Автора

Чтобы увидеть и отменить предложенный пост, нужно:
1. Выбрать в меню "Мои посты"
2. Выбрать неопубликованный пост (в начале списка должны быть, с каким-нибудь значком)
3. Нажать на кнопку с корзинкой или текстом "Удалить"

### 2.5.2 Получение уведомлений

Если статус поста изменяется (заброкован/опубликован), то присылать об этом текст пользователю.
Добавить возможность отключать эти уведомления.

# 3. Реализация Сервиса

Сервис будет использовать следующий технологический стек:
- Бекэнд
  - Язык Python
    - Библиотека для миграций Alembic
  - Б/Д PostgreSQL
- Фронтэнд:
  - Язык Python
    - Библиотека pyTelegramBotAPI

Таблицы в Б/Д:
<table style="margin-left: auto; margin-right: auto;">
  <tr><th>Пользователи</th></tr>
  <tr>
    <td>Телеграмм id (PKey, Unic)</td>
  </tr>
  <tr>
    <td>Имя пользователя (varchar255)</td>
  </tr>
  <tr>
    <td>Фамилия пользователя (varchar255)</td>
  </tr>
  <tr>
    <td>Телефон пользователя (decimal30,0)</td>
  </tr>
  <tr>
    <td>Ссылка на пользователя (varchar255)</td>
  </tr>
  <tr>
    <td>Автор ли (bool)</td>
  </tr>
</table>

----

<table style="margin-left: auto; margin-right: auto;">
  <tr><th>Посты</th></tr>
  <tr>
    <td>id (PKey, Unic)</td>
  </tr>
  <tr>
    <td>Авторский текст (Text)</td>
  </tr>
  <tr>
    <td>Когда опубликовать пост (timestamp)</td>
  </tr>
  <tr>
    <td>Репост ли (bool)</td>
  </tr>
  <tr>
    <td>Текст репоста (text | null)</td>
  </tr>
  <tr>
    <td>Автор репоста (varchar255 | null | int references users(id))</td>
  </tr>
  <tr>
    <td>Ссылка на репост (varchar255 | null | varchar255 references users(link))</td>
  </tr>
</table>

----

<table style="margin-left: auto; margin-right: auto;">
  <tr><th>Теги</th></tr>
  <tr>
    <td>id (PKey, Unic)</td>
  </tr>
  <tr>
    <td>Имя (varchar255)</td>
  </tr>
</table>

----

<table style="margin-left: auto; margin-right: auto;">
  <tr><th>Теги постов</th></tr>
  <tr>
    <td>id тега (int references tags(id))</td>
  </tr>
  <tr>
    <td>id поста (int references posts(id))</td>
  </tr>
 </table>

----

<table style="margin-left: auto; margin-right: auto;">
  <tr><th>Типы шаблонов</th></tr>
  <tr>
    <td>id типа (Pkey, Unic)</td>
  </tr>
  <tr>
    <td>Название типа (varchar255)</td>
  </tr>
 </table>

----

<table style="margin-left: auto; margin-right: auto;">
  <tr><th>Шаблон поста</th></tr>
  <tr>
    <td>id шаблона (Pkey, Unic)</td>
  </tr>
  <tr>
    <td>Текст шаблона (text)</td>
  </tr>
  <tr>
    <td>Тип шаблона (int references template_types(id))</td>
  </tr>
 </table>
